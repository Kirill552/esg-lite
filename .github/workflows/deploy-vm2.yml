# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π ESG-Lite –Ω–∞ VM2
name: Deploy to VM2

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    name: Deploy to VM2
    runs-on: ubuntu-latest
    timeout-minutes: 20  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–æ 20 –º–∏–Ω—É—Ç
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VM2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM2_HOST }}
        username: ${{ secrets.VM2_USER }}
        key: ${{ secrets.VM2_SSH_KEY }}
        port: 22
        timeout: 15m  # –¢–∞–π–º–∞—É—Ç SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        command_timeout: 10m  # –¢–∞–π–º–∞—É—Ç –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
        script: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π ESG-Lite..."
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
          cd /opt/esg-lite || { echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /opt/esg-lite –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"; exit 1; }
          
          # –°–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
          if [ ! -f ./ssl/nginx-selfsigned.crt ]; then
            echo "üîê –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç..."
            mkdir -p ./ssl
            openssl genrsa -out ./ssl/nginx-selfsigned.key 2048
            openssl req -new -x509 -key ./ssl/nginx-selfsigned.key \
              -out ./ssl/nginx-selfsigned.crt -days 365 \
              -subj "/C=RU/ST=Moscow/L=Moscow/O=ESG-Lite/CN=82.202.156.35"
            chmod 600 ./ssl/nginx-selfsigned.key
            chmod 644 ./ssl/nginx-selfsigned.crt
          fi
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
          docker compose -f docker-compose.prod.yml down
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
          echo "üì• –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ GitHub..."
          git fetch origin
          git reset --hard origin/main
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ authorized_key.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ ! -f authorized_key.json ]; then
            echo "‚ö†Ô∏è authorized_key.json –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–æ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
          fi
          
          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
          echo "üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã..."
          docker image prune -f
          
          # –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (—Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π)
          echo "üî® –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
          DOCKER_BUILDKIT=1 COMPOSE_DOCKER_CLI_BUILD=1 docker compose -f docker-compose.prod.yml up -d --build --parallel
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
          echo "üóÉÔ∏è –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
          docker compose -f docker-compose.prod.yml exec -T esg-lite-web sh -c 'DATABASE_URL="${{ secrets.PRODUCTION_DATABASE_URL }}" npx prisma migrate deploy'
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ 296-–§–ó
          echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ –≤—ã–±—Ä–æ—Å–æ–≤..."
          docker compose -f docker-compose.prod.yml exec -T esg-lite-web sh -c 'node scripts/update-emission-factors.js --check || echo "‚ö†Ô∏è –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è"'
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
          echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
          sleep 30
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
          docker compose -f docker-compose.prod.yml ps
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏
          echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
          docker compose -f docker-compose.prod.yml logs --tail=20
          
          echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"

    - name: Health Check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM2_HOST }}
        username: ${{ secrets.VM2_USER }}
        key: ${{ secrets.VM2_SSH_KEY }}
        port: 22
        script: |
          cd /opt/esg-lite
          echo "üè• –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          
          # –ñ–¥–µ–º –ø–æ–ª–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
          sleep 60
          
          # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
          docker compose -f docker-compose.prod.yml ps
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–∏–µ –ø–æ—Ä—Ç—ã —Å–ª—É—à–∞—é—Ç—Å—è..."
          ss -tlnp | grep -E ":80|:443|:3000" || netstat -tlnp | grep -E ":80|:443|:3000" || echo "–ü–æ—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ nginx
          if curl -f -k https://localhost/api/queue/health; then
            echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
            echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://esg-lite.ru"
          else
            echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ nginx, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ø—Ä—è–º—É—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
            if docker compose -f docker-compose.prod.yml exec -T esg-lite-web curl -f http://localhost:3000/api/queue/health; then
              echo "‚ö†Ô∏è –í–µ–±-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ nginx –Ω–µ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç"
            else
              echo "‚ùå –í–µ–±-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
            fi
            echo "üìã –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker compose -f docker-compose.prod.yml logs --tail=50
            exit 1
          fi

    - name: Notify Success
      if: success()
      run: |
        echo "üéâ –î–µ–ø–ª–æ–π –Ω–∞ VM2 —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
        echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: https://esg-lite.ru"

    - name: Notify Failure
      if: failure()
      run: |
        echo "‚ùå –î–µ–ø–ª–æ–π –Ω–∞ VM2 –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!"
        echo "üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º—ã"