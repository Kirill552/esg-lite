# ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ ESG-Lite
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð´Ð»Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ñ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÑ‚ÐµÐºÐ° (ÐÐ²Ð³ÑƒÑÑ‚ 2025)

name: Dependencies & Security Monitoring

on:
  schedule:
    # ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº Ð² 9:00 UTC (12:00 ÐœÐ¡Ðš)
    - cron: '0 9 * * 1'
  workflow_dispatch: # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
  push:
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'Dockerfile'
      - 'Dockerfile.worker'

jobs:
  # ============================================================================
  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
  # ============================================================================
  dependency-check:
    name: Check Dependency Updates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.18.0'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Check for outdated packages
      run: |
        echo "ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹..."
        npm outdated || true
        
    - name: Check current versions vs targets
      run: |
        echo "ðŸŽ¯ Ð¦ÐµÐ»ÐµÐ²Ñ‹Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸ (ÐÐ²Ð³ÑƒÑÑ‚ 2025):"
        echo "Next.js: 15.4.5"
        echo "React: 19.1.0" 
        echo "Tailwind CSS: 4.1.11"
        echo "Prisma: 6.13.0"
        echo "Node.js: 22.18.0"
        echo ""
        echo "ðŸ“‹ Ð¢ÐµÐºÑƒÑ‰Ð¸Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸:"
        npm list next react tailwindcss prisma --depth=0 || true

    - name: Create dependency report
      run: |
        echo "# Dependency Report $(date)" > dependency-report.md
        echo "" >> dependency-report.md
        echo "## Current Stack" >> dependency-report.md
        npm list --depth=0 >> dependency-report.md 2>&1 || true
        echo "" >> dependency-report.md
        echo "## Outdated Packages" >> dependency-report.md
        npm outdated >> dependency-report.md 2>&1 || true

    - name: Upload dependency report
      uses: actions/upload-artifact@v4
      with:
        name: dependency-report
        path: dependency-report.md

  # ============================================================================
  # ÐÑƒÐ´Ð¸Ñ‚ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
  # ============================================================================
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.18.0'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run npm audit
      run: |
        echo "ðŸ”’ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð°ÑƒÐ´Ð¸Ñ‚ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸..."
        npm audit --audit-level=moderate || true
        
    - name: Generate security report
      run: |
        echo "# Security Audit Report $(date)" > security-report.md
        echo "" >> security-report.md
        echo "## NPM Audit Results" >> security-report.md
        npm audit --audit-level=low >> security-report.md 2>&1 || true

    - name: Check for critical vulnerabilities
      run: |
        if npm audit --audit-level=critical; then
          echo "âœ… ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾"
        else
          echo "âš ï¸ ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸!"
          echo "::warning::ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÑ…"
        fi

    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.md

  # ============================================================================
  # Docker Base Image Security Scan
  # ============================================================================
  docker-security:
    name: Docker Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build test image
      run: |
        echo "ðŸ³ Ð¡Ñ‚Ñ€Ð¾Ð¸Ð¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¾Ð±Ñ€Ð°Ð· Ð´Ð»Ñ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ..."
        docker build -t esg-lite-security-test:latest -f Dockerfile .
        
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'esg-lite-security-test:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Check Node.js base image version
      run: |
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð±Ð°Ð·Ð¾Ð²Ð¾Ð³Ð¾ Ð¾Ð±Ñ€Ð°Ð·Ð° Node.js..."
        docker run --rm esg-lite-security-test:latest node --version
        echo "Ð¦ÐµÐ»ÐµÐ²Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ: v22.18.0"

  # ============================================================================
  # Ð’ÐµÑ€ÑÐ¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
  # ============================================================================
  version-tracking:
    name: Version Tracking
    runs-on: ubuntu-latest
    needs: [dependency-check, security-audit]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create version summary
      run: |
        echo "# ESG-Lite Stack Status $(date)" > version-summary.md
        echo "" >> version-summary.md
        echo "## Target Versions (ÐÐ²Ð³ÑƒÑÑ‚ 2025)" >> version-summary.md
        echo "- **Node.js**: 22.18.0 LTS" >> version-summary.md
        echo "- **Next.js**: 15.4.5" >> version-summary.md
        echo "- **React**: 19.1.0" >> version-summary.md
        echo "- **Tailwind CSS**: 4.1.11" >> version-summary.md
        echo "- **Prisma**: 6.13.0" >> version-summary.md
        echo "- **TypeScript**: 5.7.3" >> version-summary.md
        echo "" >> version-summary.md
        echo "## Status" >> version-summary.md
        if [[ "${{ needs.dependency-check.result }}" == "success" ]]; then
          echo "âœ… Dependency Check: Passed" >> version-summary.md
        else
          echo "âŒ Dependency Check: Failed" >> version-summary.md
        fi
        if [[ "${{ needs.security-audit.result }}" == "success" ]]; then
          echo "âœ… Security Audit: Passed" >> version-summary.md
        else
          echo "âŒ Security Audit: Failed" >> version-summary.md
        fi

    - name: Upload version summary
      uses: actions/upload-artifact@v4
      with:
        name: version-summary
        path: version-summary.md

    - name: Create issue for critical updates
      if: needs.security-audit.result == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸš¨ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÑ…',
            body: `## ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸
            
            Workflow \`${{ github.workflow }}\` Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶Ð¸Ð» ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÑ….
            
            **Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ:**
            1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ security-report
            2. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ÑƒÑÐ·Ð²Ð¸Ð¼Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹
            3. ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
            4. Ð Ð°Ð·Ð²ÐµÑ€Ð½Ð¸Ñ‚Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
            
            **Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° workflow:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ $(date)`,
            labels: ['security', 'critical', 'dependencies']
          })

  # ============================================================================
  # Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÑŽ
  # ============================================================================
  update-recommendations:
    name: Update Recommendations
    runs-on: ubuntu-latest
    needs: [dependency-check]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check latest versions from registries
      run: |
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð² Ñ€ÐµÐµÑÑ‚Ñ€Ð°Ñ…..."
        echo "ðŸ“¦ Next.js latest:" 
        npm view next version || true
        echo "ðŸ“¦ React latest:"
        npm view react version || true  
        echo "ðŸ“¦ Tailwind CSS latest:"
        npm view tailwindcss version || true
        echo "ðŸ“¦ Prisma latest:"
        npm view prisma version || true
        
    - name: Generate update recommendations
      run: |
        echo "# Update Recommendations $(date)" > update-recommendations.md
        echo "" >> update-recommendations.md
        echo "## Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÑŽ" >> update-recommendations.md
        echo "" >> update-recommendations.md
        echo "### ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹:" >> update-recommendations.md
        echo "- Ð¡Ñ€Ð°Ð²Ð½Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸ Ñ Ñ†ÐµÐ»ÐµÐ²Ñ‹Ð¼Ð¸" >> update-recommendations.md
        echo "- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ breaking changes Ð² changelog" >> update-recommendations.md
        echo "- ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Docker Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸" >> update-recommendations.md
        echo "" >> update-recommendations.md
        echo "### ÐŸÐ¾Ñ€ÑÐ´Ð¾Ðº Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ:" >> update-recommendations.md
        echo "1. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Node.js Ð² Dockerfile Ð¸ GitHub Actions" >> update-recommendations.md
        echo "2. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ñ„Ñ€ÐµÐ¹Ð¼Ð²Ð¾Ñ€ÐºÐ¸ (Next.js, React)" >> update-recommendations.md
        echo "3. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ (Tailwind, Prisma)" >> update-recommendations.md
        echo "4. ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÐ±Ð¾Ñ€ÐºÑƒ Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ð¹" >> update-recommendations.md

    - name: Upload recommendations
      uses: actions/upload-artifact@v4
      with:
        name: update-recommendations
        path: update-recommendations.md
