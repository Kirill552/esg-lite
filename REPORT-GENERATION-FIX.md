# Report Generation Fix - Data Mapping Issue

## üîç –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞–π–¥–µ–Ω–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞!

### –ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–∫–∏ –∏–∑ –ª–æ–≥–æ–≤:

```
üìã –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞: {
  reportType: 'REPORT_296FZ',
  emissionData: {
    inn: '8910002621',
    companyName: '–ê–û "–ú–ï–°–°–û–Ø–•–ê–ù–ï–§–¢–ï–ì–ê–ó"',
    // ... –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ
  }
}

üìã –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ 296-FZ –¥–ª—è –ù–µ —É–∫–∞–∑–∞–Ω–æ  ‚Üê –ü–†–û–ë–õ–ï–ú–ê!
‚úÖ –®–∞–±–ª–æ–Ω 296-FZ –∑–∞–≥—Ä—É–∂–µ–Ω
‚ùå –û—à–∏–±–∫–∞: –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–∞
```

### –ü—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–∫–∏:
–î–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ `body.emissionData.companyName`, –∞ –∫–æ–¥ –∏—Å–∫–∞–ª –≤ `body.companyData.name`

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –º–∞–ø–ø–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –≤ `app/api/reports/route.ts`:

```typescript
// –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
org_name: body.companyData?.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',

// –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
const companyData = body.companyData || body.emissionData || {};
org_name: companyData.companyName || companyData.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
```

### 2. –£–ª—É—á—à–µ–Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:

```typescript
const reportGenerationData: ReportGenerationData = {
  // –û–±—â–∏–µ –ø–æ–ª—è
  org_name: companyData.companyName || companyData.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
  org_address: companyData.address || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
  signer_name: signerData.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
  
  // –ü–æ–ª—è –¥–ª—è 296-FZ —Å fallback –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
  org_inn: companyData.inn || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
  org_okpo: companyData.okpo || companyData.ogrn || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
  org_oktmo: companyData.oktmo || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
  org_phone: companyData.phone || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
  org_email: companyData.email || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
  report_year: companyData.reportingPeriod || body.reportPeriod || '2025',
  
  // –û—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  ...body.emissionData,
  ...body.goodsData
};
```

### 3. –£–ª—É—á—à–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ `lib/template-engine.ts`:

```typescript
// –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
requiredTokens.forEach(token => {
  const value = String(data[token] || '').trim();
  if (!value || value === '–ù–µ —É–∫–∞–∑–∞–Ω–æ') {
    errors.push(`–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω: ${token} (–∑–Ω–∞—á–µ–Ω–∏–µ: "${value}")`);
  }
});
```

### 4. –°–æ–∑–¥–∞–Ω debug endpoint –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:

```typescript
// POST /api/reports/debug
// –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –∞–Ω–∞–ª–∏–∑ –º–∞–ø–ø–∏–Ω–≥–∞
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

### –¢–µ—Å—Ç–æ–≤—ã–π API —Ä–∞–±–æ—Ç–∞–µ—Ç:
```bash
GET /api/reports/test
Status: 200 OK
Results: 296-FZ ‚úÖ, CBAM ‚úÖ
```

### –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
```bash
POST /api/reports/debug
# –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ –∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π API
# –ü–æ–ª—É—á–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
```

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—É—é –æ–∂–∏–¥–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞:

### –î–ª—è 296-FZ –æ—Ç—á–µ—Ç–∞:
```json
{
  "reportType": "REPORT_296FZ",
  "emissionData": {
    "companyName": "–ê–û \"–ú–ï–°–°–û–Ø–•–ê–ù–ï–§–¢–ï–ì–ê–ó\"",
    "inn": "8910002621",
    "address": "629303, –Ø–ù–ê–û, –≥. –ù–æ–≤—ã–π –£—Ä–µ–Ω–≥–æ–π...",
    "reportingPeriod": "2024",
    "ogrn": "1028900622266"
  },
  "signerData": {
    "name": "–ò–≤–∞–Ω–æ–≤ –ò.–ò.",
    "position": "–î–∏—Ä–µ–∫—Ç–æ—Ä"
  }
}
```

### –î–ª—è CBAM –æ—Ç—á–µ—Ç–∞:
```json
{
  "reportType": "CBAM_QUARTERLY",
  "companyData": {
    "name": "–û–û–û \"–≠–∫—Å–ø–æ—Ä—Ç\"",
    "eori": "RU123456789012345",
    "address": "–ú–æ—Å–∫–≤–∞, —É–ª. –≠–∫—Å–ø–æ—Ä—Ç–Ω–∞—è, 1"
  },
  "goodsData": {
    "l1_cn": "72081000",
    "l1_qty": "100.0",
    // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è —Ç–æ–≤–∞—Ä–æ–≤
  }
}
```

## üöÄ –°—Ç–∞—Ç—É—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

- ‚úÖ **–ú–∞–ø–ø–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è** - —É–ª—É—á—à–µ–Ω–∞  
- ‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **–û—Ç–ª–∞–¥–∫–∞** - —Å–æ–∑–¥–∞–Ω debug endpoint
- ‚úÖ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Ç–µ—Å—Ç–æ–≤—ã–π API —Ä–∞–±–æ—Ç–∞–µ—Ç

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ —á–µ—Ä–µ–∑ UI
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å** debug endpoint —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
3. **–£–±–µ–¥–∏—Ç—å—Å—è** —á—Ç–æ PDF –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å** –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞! –°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.** ‚úÖ